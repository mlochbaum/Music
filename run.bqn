# Synthesis script runner

lfâ†@+10
acâ†"_"âˆ¾â¥Š"aA"+âŒœâ†•26

# Source to list of token strings
Tokenizeâ†{
  wsâ†" "âˆ¾@+9                                # Whitespace: space and tab
  wcâ†acâˆ¾'0'+â†•10                             # Word characters

  # Resolve comments and strings
  sâ€¿dâ†/Â¨2â†‘smâ€¿dmâ€¿câ€¿nâ†ğ•©âŠ¸=Â¨"'""#"âˆ¾lf
  gâ†â‹qâ†âˆ¾âŸ¨  sâ‹„Â¯1â†“dâ‹„/câŸ© â‹„qâ†©gâŠq                # Open indices
  eâ† gâŠâˆ¾âŸ¨2+sâ‹„ 1â†“dâ‹„-âŸœÂ»âˆ˜âŠâŸœ(0âˆ¾+`c)âŠ¸//nâˆ¾1âŸ©      # Matching close indices
  Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ(0=Â¯1âŠ‘âŠ¢)       # Mark reachable openings
  aâ€¿bâ†((â‰ ğ•©)â†‘Â·/â¼((â‰ â†‘âˆ¾âŸœâ‰ Se 1âˆ¾0Â¨)qâ‹e)âŠ¸/)Â¨qâ€¿e   # Open/close masks
  qeâ†aâˆ§âˆ§âŸœÂ«dm                                # Quote Escape ""
  kâ†qeâˆ¨Â»â‰ `abâ†aâˆ¨b                            # Token continuation mask
  {âŸ¨âŠ‘/ğ•©,"Unclosed quote"âŸ©!0}âŸ(âˆ¨Â´)(smâˆ¨dm)>kâˆ¨a

  ignâ†(ğ•©âˆŠws)âˆ¨iiâ†â‰ `abâˆ§câˆ¨n                    # Ignored characters
  kâˆ¨â†©Â»âŠ¸âˆ§k<lâ†ğ•©âˆŠwc                            # Group words
  kâˆ¨â†©Â»ğ•©='â€¢'
  tsâ†nâˆ¨Â¬kâˆ¨ign                               # Token start mask
  âŸ¨ğ•©âŠ”Ëœ1-Ëœ(iiâˆ¨k<ign)Â¬âŠ¸Ã—+`ts, /tsâŸ©
}
Statementsâ†{ğ•Š tokâ€¿pos:
  sep â† â¥ŠÂ¨",â‹„"âˆ¾lf
  brakâ†(â¥ŠÂ¨"{}âŸ¨âŸ©")â‰¡âŒœtok
  asgnâ† â¥ŠÂ¨"â†â‡"#â†©
  lev â† +`-Ëbrak
  gâ†(1-ËœÂ¬Ã—1+`1âŠ¸(Â»<âŠ¢))(0=lev)âˆ§tokâˆŠsep
  tâ€¿pâ€¿lâ€¿b â† gâŠ¸âŠ”Â¨ğ•©âˆ¾âŸ¨Â»lev,0=+`-Ë2â†‘brakâŸ©
  vgâ†l{(acâˆŠËœâŠ‘Â¨ğ•©)Ã—1+â‰ `Â«âŠ¸â‰ âŒ¾((â‹ğ•¨)âŠ¸âŠ)ğ•©âˆŠasgn}Â¨t
  ioâ†(âŠ¢+32Ã—1="A["âŠ¸â‹âš‡1)<Ë˜â‰>tâŠ”ËœÂ¨b(2âˆ¾Ëœ1-Ëœ1âŠ¸+âŠ¸âŒŠ)Â¨vg
  âŸ¨âŠ‘Â¨p,tâŸ©âˆ¾io
}

repl â† â€¢BQN{(ğ”½âŠ‘)âŠ(ğ”½1âŠ¸âŠ‘)} "â€¢ReBQN{replâ‡""strict""}"â€¿"â€¢Eval"
Eval â† (â€¢args{(âŠ‘ğ•¨)âŒ¾(1âŠ¸âŠ‘)âŸ(0<â‰ ğ•¨)ğ•©}â€¢state)âŠ¸Repl
Evalâ€¢FChars"synth.bqn"
runLineâ†{
  lines â† âŸ¨âŸ©      # Tokens and predecessor line IDs
  cache â† âŸ¨âŸ©      # Corresponding result namespace
  RL â† {tokâ€¿iidâ€¿codeâ€¿inâ€¿out ğ•Š ci:
    Listâ†"âŸ¨"âˆ¾"âŸ©"Â«Â·âˆ¾","âŠ¸âˆ¾Â¨
    _Eâ†{(0<â‰ âˆ˜âŠ¢)â—¶""â€¿ğ”½}
    fn â† Eval âˆ¾âŸ¨"{"
      iid("â†"âˆ¾ËœÂ·ListÂ·ListÂ¨âŠâŠ¸âŠ”)_E in,  "ğ•©â‹„"
      code
      ("â‡"âˆ¾ËœList)_E out
    "}"âŸ©
    res â† Fn (â·iid)âŠcache
    (0<â‰ out)â—¶Â¯1â€¿{cacheâˆ¾â†©<resâ‹„1-Ëœâ‰ linesâˆ¾â†©<ğ•©} tokâ€¿iid
  }{
    ğ•© ğ”½âŸ((â‰ lines)âŠ¸â‰¤) âŠ‘linesâŠ<2â†‘ğ•©
  }
}

RunAllâ†{
  posâ€¿tokâ€¿inâ€¿out â† Statements Tokenize ğ•©
  code â† (1-Ëœ/ğ•©(â‰ âŠ¸Â«-âŠ¢)0âˆ¾pos)âŠ”ğ•©
  in â†© â·Â¨in
  id â† (/â‰ Â¨in)âŠ”out((+`â‰ Â¨out)â‹âŠ)â—‹âˆ¾in  # TODO redefinition
  inâ€¿id /Â¨ËœÂ¨â†© <id<â†•â‰ id
  liâ†âŸ¨âŸ© â‹„ @âˆ˜{liâˆ¾â†©RunLine âŠâŸœliâŒ¾(1âŠ¸âŠ‘)ğ•©}Ë˜ â‰>âŸ¨tok,id,code,in,outâŸ©
  li
}
â€¢args {ğ•Â·âˆ¾Â·â€¢FCharsÂ¨ğ•¨Ë™}âŸ(0<â‰ âˆ˜âŠ£) runAll
